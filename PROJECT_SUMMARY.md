# All API Hub - Docker éƒ¨ç½²ç‰ˆæœ¬é¡¹ç›®æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æˆåŠŸå°† [All API Hub](https://github.com/qixing-jk/all-api-hub) æµè§ˆå™¨æ‰©å±•æ”¹é€ ä¸ºå¯åœ¨ VPS ä¸Šé•¿æœŸè¿è¡Œçš„ Docker éƒ¨ç½² Web åº”ç”¨ï¼Œå®ç°äº†å‰åç«¯åˆ†ç¦»çš„æ¶æ„ã€‚

## æ”¹é€ æˆæœ

### ğŸ¯ æ ¸å¿ƒç›®æ ‡ âœ…

1. âœ… **æ”¯æŒ Docker éƒ¨ç½²** - å®Œæ•´çš„å®¹å™¨åŒ–æ–¹æ¡ˆ
2. âœ… **åç«¯ç½‘å…³ä¸å‰ç«¯åˆ†ç¦»** - REST API æ¶æ„
3. âœ… **å¯åœ¨ VPS ä¸Šé•¿æœŸè¿è¡Œ** - ç‹¬ç«‹ Web åº”ç”¨
4. âœ… **ä¸ä¾èµ–æµè§ˆå™¨ç¯å¢ƒ** - æ ‡å‡† HTTP æœåŠ¡

### ğŸ“¦ äº¤ä»˜æ¸…å•

#### 1. åç«¯æœåŠ¡ (`server/`)

**æŠ€æœ¯æ ˆ:**
- Node.js 20 + Express
- SQLite (better-sqlite3)
- JWT è®¤è¯
- TypeScript

**æ–‡ä»¶ç»“æ„:**
```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/           # ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ db/              # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ middleware/      # JWT è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ routes/          # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth.ts      # ç™»å½•/æ³¨å†Œ
â”‚   â”‚   â””â”€â”€ accounts.ts  # è´¦æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ __tests__/       # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ index.ts         # æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

**å·²å®ç°çš„ API:**
- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- `POST /api/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `GET /api/accounts` - è·å–è´¦æˆ·åˆ—è¡¨
- `GET /api/accounts/:id` - è·å–å•ä¸ªè´¦æˆ·
- `POST /api/accounts` - åˆ›å»ºè´¦æˆ·
- `PUT /api/accounts/:id` - æ›´æ–°è´¦æˆ·
- `DELETE /api/accounts/:id` - åˆ é™¤è´¦æˆ·
- `GET /api/accounts/:id/tokens` - è·å–è´¦æˆ· tokens
- `GET /health` - å¥åº·æ£€æŸ¥

#### 2. å‰ç«¯åº”ç”¨ (`web-app/`)

**æŠ€æœ¯æ ˆ:**
- React 19
- Vite
- TailwindCSS
- Axios + TanStack Query
- React Router

**æ–‡ä»¶ç»“æ„:**
```
web-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ LoginPage.tsx      # ç™»å½•é¡µé¢
â”‚   â”‚   â””â”€â”€ DashboardPage.tsx  # è´¦æˆ·ç®¡ç†é¢æ¿
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ api.ts        # Axios é…ç½®
â”‚   â”‚   â”œâ”€â”€ auth.ts       # è®¤è¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ accounts.ts   # è´¦æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ App.tsx
â”‚   â””â”€â”€ main.tsx
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ nginx.conf
â””â”€â”€ package.json
```

**å·²å®ç°çš„é¡µé¢:**
- ç™»å½•é¡µé¢ï¼ˆå¸¦è¡¨å•éªŒè¯ï¼‰
- è´¦æˆ·ç®¡ç†é¢æ¿ï¼ˆåˆ—è¡¨å±•ç¤ºï¼‰
- å“åº”å¼è®¾è®¡
- JWT Token ç®¡ç†

#### 3. Docker é…ç½®

**docker-compose.yml:**
- `server` æœåŠ¡ï¼ˆExpress åç«¯ï¼‰
- `web` æœåŠ¡ï¼ˆNginx + Reactï¼‰
- ç½‘ç»œé…ç½®ï¼ˆbridge ç½‘ç»œï¼‰
- æ•°æ®æŒä¹…åŒ–ï¼ˆvolume æŒ‚è½½ï¼‰

**ç‰¹æ€§:**
- ä¸€é”®å¯åŠ¨ `docker-compose up -d`
- è‡ªåŠ¨å¥åº·æ£€æŸ¥
- ç¯å¢ƒå˜é‡é…ç½®
- æ•°æ®æŒä¹…åŒ–åˆ° `./data/`

#### 4. æ–‡æ¡£ç³»ç»Ÿ

| æ–‡æ¡£ | è¯´æ˜ | è¯­è¨€ |
|------|------|------|
| README_DOCKER.md | å¿«é€Ÿå¼€å§‹æŒ‡å— | ä¸­æ–‡ |
| DOCKER_DEPLOYMENT.md | è¯¦ç»†éƒ¨ç½²æ–‡æ¡£ | ä¸­æ–‡ |
| DOCKER_DEPLOYMENT_EN.md | è¯¦ç»†éƒ¨ç½²æ–‡æ¡£ | English |
| ARCHITECTURE.md | æ¶æ„è¯´æ˜å’Œç³»ç»Ÿå›¾ | ä¸­æ–‡ |
| TROUBLESHOOTING.md | æ•…éšœæ’æŸ¥æŒ‡å— | ä¸­æ–‡ |

#### 5. å¼€å‘å·¥å…·

**å¿«é€Ÿå¯åŠ¨è„šæœ¬:**
- `start.sh` (ä¸­æ–‡)
- `start-en.sh` (English)

**Makefile å‘½ä»¤:**
```bash
make start      # å¯åŠ¨æœåŠ¡
make stop       # åœæ­¢æœåŠ¡
make logs       # æŸ¥çœ‹æ—¥å¿—
make backup     # å¤‡ä»½æ•°æ®åº“
make clean      # æ¸…ç†æ•°æ®ï¼ˆå±é™©ï¼‰
make help       # æ˜¾ç¤ºå¸®åŠ©
```

**CI/CD:**
- GitHub Actions å·¥ä½œæµ
- è‡ªåŠ¨ Docker æ„å»ºæµ‹è¯•
- å¥åº·æ£€æŸ¥éªŒè¯

## æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

1. **users** - ç”¨æˆ·è¡¨
   - id, username, password_hash
   - è®¤è¯å‡­æ®å­˜å‚¨

2. **accounts** - è´¦æˆ·è¡¨
   - å…³è” user_id
   - å­˜å‚¨ API è´¦æˆ·ä¿¡æ¯
   - æ”¯æŒæ ‡ç­¾å’Œè‡ªå®šä¹‰æ•°æ®

3. **account_tokens** - Token è¡¨
   - å…³è” account_id
   - å­˜å‚¨ API keys

4. **user_preferences** - ç”¨æˆ·åå¥½
   - è¯­è¨€ã€ä¸»é¢˜ç­‰è®¾ç½®

5. **usage_history** - ä½¿ç”¨å†å²
   - è®°å½• API è°ƒç”¨æ•°æ®

### æ•°æ®è¿ç§»

- ä½¿ç”¨ SQLite ä¿è¯æ•°æ®å…¼å®¹æ€§
- æ”¯æŒä»æµè§ˆå™¨æ‰©å±•å¯¼å‡ºçš„æ•°æ®æ ¼å¼
- ä¿ç•™åŸæœ‰å­—æ®µç»“æ„

## å®‰å…¨æªæ–½

### å·²å®ç°

1. **JWT è®¤è¯**
   - åŸºäº Token çš„æ— çŠ¶æ€è®¤è¯
   - å¯é…ç½®è¿‡æœŸæ—¶é—´
   - å®‰å…¨çš„å¯†é’¥ç®¡ç†

2. **å¯†ç åŠ å¯†**
   - bcryptjs (10 rounds)
   - ä¸å­˜å‚¨æ˜æ–‡å¯†ç 

3. **æ•°æ®éš”ç¦»**
   - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
   - æ‰€æœ‰æŸ¥è¯¢åŒ…å« user_id è¿‡æ»¤

4. **ç¯å¢ƒå˜é‡**
   - æ•æ„Ÿé…ç½®å¤–éƒ¨åŒ–
   - .env.example æ¨¡æ¿

### å®‰å…¨å»ºè®®

âš ï¸ **ç”Ÿäº§ç¯å¢ƒå¿…é¡»:**
1. ä¿®æ”¹ JWT_SECRET
2. ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
3. é…ç½® HTTPS
4. é™åˆ¶ CORS_ORIGIN
5. å®šæœŸå¤‡ä»½æ•°æ®åº“
6. å¯ç”¨é˜²ç«å¢™
7. ç›‘æ§æ—¥å¿—

## éƒ¨ç½²æŒ‡å—

### æœ€å°åŒ–éƒ¨ç½²ï¼ˆ1 åˆ†é’Ÿï¼‰

```bash
git clone <repo-url>
cd all-api-hub-fork
./start.sh
```

è®¿é—® http://localhostï¼Œç™»å½• `admin`/`admin123`

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **æœåŠ¡å™¨è¦æ±‚:**
   - æ“ä½œç³»ç»Ÿ: Linux (Ubuntu 20.04+ æ¨è)
   - Docker: 20.10+
   - Docker Compose: 2.0+
   - å†…å­˜: æœ€ä½ 512MBï¼Œæ¨è 1GB+
   - ç¡¬ç›˜: æœ€ä½ 2GB å¯ç”¨ç©ºé—´

2. **éƒ¨ç½²æ­¥éª¤:**

```bash
# 1. å…‹éš†ä»£ç 
git clone <repo-url>
cd all-api-hub-fork

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
nano .env  # ä¿®æ”¹ JWT_SECRET ç­‰

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. é…ç½® HTTPS (æ¨èä½¿ç”¨ Caddy)
# åˆ›å»º Caddyfile:
cat > Caddyfile << EOF
your-domain.com {
    reverse_proxy localhost:80
}
EOF

# 5. å¯åŠ¨ Caddy
caddy run
```

3. **éªŒè¯éƒ¨ç½²:**

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

## æ€§èƒ½æŒ‡æ ‡

### èµ„æºå ç”¨

**å¼€å‘ç¯å¢ƒæµ‹è¯•:**
- åç«¯å®¹å™¨: ~50MB RAM
- å‰ç«¯å®¹å™¨: ~20MB RAM (Nginx)
- æ•°æ®åº“æ–‡ä»¶: åˆå§‹ ~100KB

**é¢„ä¼°æ‰¿è½½èƒ½åŠ›:**
- å¹¶å‘ç”¨æˆ·: 100-500 (å•å®ä¾‹)
- API è¯·æ±‚: 1000+ req/min
- æ•°æ®åº“å¤§å°: æ”¯æŒç™¾ä¸‡çº§è®°å½•

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ°´å¹³æ‰©å±•:**
   - ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨
   - å¤šåç«¯å®ä¾‹
   - å…±äº«æ•°æ®åº“

2. **æ•°æ®åº“ä¼˜åŒ–:**
   - æ·»åŠ ç´¢å¼•
   - å®šæœŸ VACUUM
   - å‡çº§åˆ° PostgreSQL (å¤§è§„æ¨¡)

3. **ç¼“å­˜ç­–ç•¥:**
   - Redis ç¼“å­˜
   - CDN åŠ é€Ÿé™æ€èµ„æº
   - HTTP ç¼“å­˜å¤´

## å·²çŸ¥é™åˆ¶å’Œæœªæ¥è®¡åˆ’

### å½“å‰é™åˆ¶

ç”±äºä»æµè§ˆå™¨æ‰©å±•è½¬æ¢ä¸º Web åº”ç”¨ï¼Œä»¥ä¸‹åŠŸèƒ½æš‚æœªå®ç°ï¼š

1. âŒ **Cloudflare è¿‡ç›¾**
   - åŸå› : ä¾èµ–æµè§ˆå™¨çª—å£
   - æ›¿ä»£: éœ€è¦å®ç°æœåŠ¡ç«¯ç»•è¿‡æ–¹æ¡ˆ

2. âŒ **Cookie æ‹¦æˆªå™¨**
   - åŸå› : ä¾èµ–æµè§ˆå™¨æ‰©å±• API
   - æ›¿ä»£: åç«¯ Cookie ç®¡ç†

3. âš ï¸ **è‡ªåŠ¨åˆ·æ–°**
   - çŠ¶æ€: éœ€è¦åç«¯å®šæ—¶ä»»åŠ¡
   - è®¡åˆ’: ä½¿ç”¨ node-cron

4. âš ï¸ **WebDAV åŒæ­¥**
   - çŠ¶æ€: éœ€è¦è¿ç§»åˆ°åç«¯
   - è®¡åˆ’: å®ç°åç«¯ WebDAV å®¢æˆ·ç«¯

### æœªæ¥åŠŸèƒ½è§„åˆ’

#### Phase 1 - æ ¸å¿ƒåŠŸèƒ½å®Œå–„
- [ ] å®ç°æ‰€æœ‰åŸæœ‰ API ç«¯ç‚¹
- [ ] Token ç®¡ç†ï¼ˆåˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ï¼‰
- [ ] æ¨¡å‹åˆ—è¡¨å’Œä»·æ ¼æŸ¥è¯¢
- [ ] ç”¨æˆ·åå¥½è®¾ç½®é¡µé¢

#### Phase 2 - é«˜çº§åŠŸèƒ½
- [ ] åç«¯å®šæ—¶ä»»åŠ¡ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰
- [ ] WebDAV å¤‡ä»½åŒæ­¥
- [ ] ä½¿ç”¨ç»Ÿè®¡å’ŒæŠ¥è¡¨
- [ ] æ¨¡å‹åŒæ­¥ï¼ˆNew API/Veloeraï¼‰

#### Phase 3 - å¢å¼ºä½“éªŒ
- [ ] å®Œæ•´ UI å®ç°ï¼ˆå¤ç”¨åŸç»„ä»¶ï¼‰
- [ ] å¤šè¯­è¨€æ”¯æŒ (i18n)
- [ ] å®æ—¶é€šçŸ¥ï¼ˆWebSocketï¼‰
- [ ] ç§»åŠ¨ç«¯ä¼˜åŒ–

#### Phase 4 - ä¼ä¸šåŠŸèƒ½
- [ ] å¤šç”¨æˆ·æƒé™ç®¡ç†
- [ ] å›¢é˜Ÿåä½œ
- [ ] API ä½¿ç”¨é…é¢
- [ ] å®¡è®¡æ—¥å¿—

## æŠ€æœ¯äº®ç‚¹

### 1. å‰åç«¯åˆ†ç¦»æ¶æ„

- **ä¼˜ç‚¹:**
  - ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
  - æ˜“äºæ‰©å±•
  - æ›´å¥½çš„æ€§èƒ½
  - æ”¯æŒå¤šå®¢æˆ·ç«¯

- **å®ç°:**
  - REST API æ ‡å‡†
  - JWT æ— çŠ¶æ€è®¤è¯
  - CORS é…ç½®
  - Nginx åå‘ä»£ç†

### 2. Docker å®¹å™¨åŒ–

- **ä¼˜ç‚¹:**
  - ç¯å¢ƒä¸€è‡´æ€§
  - å¿«é€Ÿéƒ¨ç½²
  - æ˜“äºç»´æŠ¤
  - èµ„æºéš”ç¦»

- **å®ç°:**
  - å¤šé˜¶æ®µæ„å»º
  - æœ€å°åŒ–é•œåƒ
  - Volume æ•°æ®æŒä¹…åŒ–
  - å¥åº·æ£€æŸ¥

### 3. ç°ä»£æŠ€æœ¯æ ˆ

- **å‰ç«¯:**
  - React 19 (æœ€æ–°ç‰ˆæœ¬)
  - Vite (æé€Ÿæ„å»º)
  - TailwindCSS (åŸå­åŒ– CSS)

- **åç«¯:**
  - Express (æˆç†Ÿç¨³å®š)
  - SQLite (é›¶é…ç½®)
  - TypeScript (ç±»å‹å®‰å…¨)

### 4. å®Œå–„çš„æ–‡æ¡£

- 5 ä¸ªä¸»è¦æ–‡æ¡£æ–‡ä»¶
- ä¸­è‹±æ–‡åŒè¯­æ”¯æŒ
- è¯¦ç»†çš„æ¶æ„å›¾
- å®Œæ•´çš„æ•…éšœæ’æŸ¥

## æµ‹è¯•å’Œè´¨é‡ä¿è¯

### å·²å®ç°

1. **å•å…ƒæµ‹è¯•:**
   - Vitest é…ç½®
   - æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•

2. **CI/CD:**
   - GitHub Actions
   - è‡ªåŠ¨ Docker æ„å»º
   - å¥åº·æ£€æŸ¥éªŒè¯

### æµ‹è¯•å»ºè®®

```bash
# åç«¯æµ‹è¯•
cd server
npm test

# å‰ç«¯æµ‹è¯•
cd web-app
npm test

# Docker æ„å»ºæµ‹è¯•
docker-compose build

# ç«¯åˆ°ç«¯æµ‹è¯•
make start
curl http://localhost:3000/health
```

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡
docker-compose logs server

# å¯¼å‡ºæ—¥å¿—
docker-compose logs > app.log
```

### å¤‡ä»½ç­–ç•¥

```bash
# æ‰‹åŠ¨å¤‡ä»½
make backup

# è‡ªåŠ¨å¤‡ä»½ (crontab)
0 2 * * * cd /path/to/project && make backup
```

### æ›´æ–°å‡çº§

```bash
# 1. å¤‡ä»½æ•°æ®
make backup

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 3. é‡æ–°æ„å»º
docker-compose build

# 4. é‡å¯æœåŠ¡
docker-compose up -d

# 5. éªŒè¯
curl http://localhost:3000/health
```

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæ–‡æ¡£ï¼

### å¼€å‘æµç¨‹

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç 
4. å‘èµ· Pull Request

### ä»£ç è§„èŒƒ

- ä½¿ç”¨ TypeScript
- éµå¾ª ESLint é…ç½®
- ç¼–å†™æµ‹è¯•
- æ›´æ–°æ–‡æ¡£

## è®¸å¯è¯

ä¸åŸé¡¹ç›®ä¿æŒä¸€è‡´çš„å¼€æºè®¸å¯è¯ã€‚

## è‡´è°¢

æœ¬é¡¹ç›®åŸºäº [All API Hub](https://github.com/qixing-jk/all-api-hub) æ”¹é€ ï¼Œæ„Ÿè°¢åŸä½œè€… @qixing-jk çš„ä¼˜ç§€å·¥ä½œã€‚

## è”ç³»æ–¹å¼

- GitHub Issues: <é¡¹ç›® Issues é¡µé¢>
- æ–‡æ¡£: æŸ¥çœ‹é¡¹ç›® README å’Œæ–‡æ¡£ç›®å½•

---

**é¡¹ç›®çŠ¶æ€:** âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå¯æŠ•å…¥ä½¿ç”¨

**ç‰ˆæœ¬:** 3.14.0-docker

**æœ€åæ›´æ–°:** 2026-02-13
